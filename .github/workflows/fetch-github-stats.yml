name: "Fetch GitHub Stats"

# Need write permission to push updated SVGs back to the repo
permissions:
  contents: write

on:
  schedule:
    # daily at 00:00 UTC
    - cron: "0 0 * * *"
  # Note: GitHub Actions cron uses UTC
  workflow_dispatch: {}

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # persist the GITHUB_TOKEN so we can push commits
          persist-credentials: true

      - name: Fetch stats and languages SVG
        run: |
          set -e
          mkdir -p public
          # Try your self-hosted service first, then official public service, finally fallback local SVGs
          if curl -fsSL "https://github-readme-stats-theadityanvs-projects.vercel.app/api?username=theAdityaNVS&theme=default&show_icons=true&hide_border=true&count_private=true" -o public/github-stats.svg; then
            echo "fetched github-stats.svg from self-hosted"
          elif curl -fsSL "https://github-readme-stats.vercel.app/api?username=theAdityaNVS&theme=default&show_icons=true&hide_border=true&count_private=true" -o public/github-stats.svg; then
            echo "fetched github-stats.svg from public service"
          else
            echo "both fetches failed — using fallback for github-stats.svg"
            cp public/github-stats-fallback.svg public/github-stats.svg || true
          fi

          if curl -fsSL "https://github-readme-stats-theadityanvs-projects.vercel.app/api/top-langs/?username=theAdityaNVS&theme=default&show_icons=true&hide_border=true&layout=compact" -o public/github-langs.svg; then
            echo "fetched github-langs.svg from self-hosted"
          elif curl -fsSL "https://github-readme-stats.vercel.app/api/top-langs/?username=theAdityaNVS&theme=default&layout=compact&hide_border=true" -o public/github-langs.svg; then
            echo "fetched github-langs.svg from public service"
          else
            echo "both fetches failed — using fallback for github-langs.svg"
            cp public/github-langs-fallback.svg public/github-langs.svg || true
          fi

      - name: Show public dir and git status (debug)
        run: |
          echo "Public directory contents:"; ls -la public || true
          echo "Git status:"; git status --porcelain || true
          echo "Git diff:"; git --no-pager diff -- public || true

      - name: Commit updated SVGs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/github-stats.svg public/github-langs.svg || true
          git commit -m "chore: update github stats (automated)" || echo "no changes to commit"
          git push origin HEAD || (
            echo "push failed — trying to open a PR instead"
            BRANCH="update/github-stats-$(date +%s)"
            git checkout -b "$BRANCH"
            git push origin "$BRANCH"
            gh pr create --title "chore: update github stats (automated)" --body "Automated update of github stats SVGs" --base main || echo "failed to create PR"
          )
